# Summary of Commit b492274

## Commit Information
- **Commit SHA**: b492274292ce081ba32edabd4b04393a0e6bf31e
- **Author**: Gergo Balaton
- **Date**: December 5, 2025
- **Message**: "Implemented long-lived BLE relay client for OAT1040 or other BLE devices (notifications + write support)"

## Overview
Commit b492274 is a pivotal addition to the BLE MITM research tool that implements the **peripheral side** of a Man-in-the-Middle (MITM) attack framework. This commit adds the relay client component, which serves as the intermediary that connects to and maintains persistent connections with target BLE devices.

## How It Fits Into The Project

### Project Evolution Timeline
1. **Dec 2, 2025**: Initial commit - Project setup
2. **Dec 2, 2025**: Basic BLE scanner (`scanner.py`) - Device discovery phase
3. **Dec 4, 2025**: GATT enumerator (`GATT_enum.py`) - Service/characteristic mapping phase
4. **Dec 5, 2025**: **THIS COMMIT (b492274)** - Relay client (`relay_client.py`) - Active MITM interaction phase

### Architectural Role
The project follows a **three-phase BLE security research workflow**:

```
Phase 1: Discovery (scanner.py)
   └─> Scan for BLE devices
   └─> Identify targets by MAC address, RSSI, services
   └─> Output: scan_results.json

Phase 2: Enumeration (GATT_enum.py)
   └─> Connect to target device
   └─> Map GATT services and characteristics
   └─> Identify readable/writable/notifiable characteristics
   └─> Analyze security vulnerabilities
   └─> Output: {MAC}_profile.json

Phase 3: Relay/MITM (relay_client.py) ⭐ THIS COMMIT
   └─> Establish persistent connection to target
   └─> Load device profile from Phase 2
   └─> Subscribe to notifications
   └─> Intercept and display data streams
   └─> Enable manual write operations
   └─> Maintain long-lived connection for analysis
```

## What Commit b492274 Does

### Files Added

#### 1. `relay_client.py` (184 lines)
The core relay client implementation with the following capabilities:

**Key Features:**
- **Persistent BLE Connection**: Connects to target devices (like OAT1040) by MAC address and maintains long-lived connections
- **Profile Integration**: Loads device profiles generated by `GATT_enum.py` to understand device structure
- **Notification Monitoring**: Automatically subscribes to all notifiable/indicatable characteristics and displays incoming data in real-time
- **Interactive Write Interface**: Provides a CLI for sending write commands to writable characteristics
- **Dual Mode Operation**: Can work with pre-enumerated profiles or dynamically discover characteristics from live services

**Main Components:**

1. **`load_profile(address)`**: 
   - Loads JSON profiles created by `GATT_enum.py`
   - Extracts notifiable and writable characteristic UUIDs
   - Returns device profile data for relay operations

2. **`find_from_live(client)`**: 
   - Fallback mechanism when profile doesn't exist
   - Dynamically discovers characteristics from connected device
   - Identifies notify/indicate and write capabilities

3. **`notification_handler(sender, data)`**: 
   - Callback for BLE notifications/indications
   - Displays data in both hex and ASCII formats
   - Enables real-time monitoring of device communications

4. **`interactive_write_loop(client, writable_uuids)`**: 
   - Interactive CLI for security research
   - Commands:
     - `list`: Show all writable characteristics
     - `write <uuid> <hexbytes>`: Send data to specific characteristic
     - `quit/exit`: Disconnect and terminate
   - Enables manual testing and command injection research

5. **`run_relay_client(address)`**: 
   - Main orchestration function
   - Manages connection lifecycle
   - Coordinates notification subscriptions
   - Handles graceful disconnection

**Usage:**
```bash
python relay_client.py <BLE_MAC_ADDRESS>
```

#### 2. `78_02_B7_2B_40_C9_profile.json` (209 lines)
An example device profile for an **OAT1040** BLE device (MAC: 78:02:B7:2B:40:C9):

**Contents:**
- **Device Information**: MAC address, MTU size (244 bytes), connection status, timestamp
- **Complete GATT Structure**: All services, characteristics, descriptors
- **Device Name**: "OAT1040" (hex: 4f41543130343000)
- **Service Details**: Multiple services including:
  - Generic Access Profile (0x1800)
  - Generic Attribute Profile (0x1801)
  - Device Information Service (0x180A)
  - Battery Service (0x180F)
  - Custom manufacturer services

**Purpose:**
- Serves as test data for the relay client
- Demonstrates the profile format expected by `relay_client.py`
- Provides a reference for testing OAT1040 device interactions

### Statistics
- **Total Lines Added**: 393 lines
- **Files Created**: 2 files
- **No Files Modified**: This is a pure addition commit
- **No Files Deleted**: Non-destructive change

## Technical Implementation Details

### BLE Protocol Support
- Uses **Bleak** library for cross-platform BLE communication
- Supports **notifications** (lightweight) and **indications** (acknowledged)
- Handles both **write** and **write-without-response** operations
- Configurable timeout (20 seconds) for connection establishment

### Data Handling
- **Hex Display**: Raw byte data in hexadecimal format
- **ASCII Rendering**: Human-readable ASCII representation with non-printable characters shown as dots
- **Profile Caching**: Reuses enumeration results to avoid redundant scanning

### Security Research Capabilities
This commit enables several security research scenarios:

1. **Passive Monitoring**: Observe device communications by subscribing to notifications
2. **Protocol Analysis**: Understand data formats and communication patterns
3. **Command Injection Testing**: Send arbitrary data to writable characteristics
4. **Replay Attacks**: Capture and replay observed commands
5. **Fuzzing Preparation**: Identify attack surfaces for subsequent fuzzing

## Integration with MITM Framework

While this commit is labeled as the "peripheral side of MITM," it's actually the **foundation** for a complete MITM setup:

**Current State (After b492274):**
```
[Researcher] ←→ [relay_client.py] ←→ [Target BLE Device]
```

**Future MITM Architecture (Implied):**
```
[Central/Phone] ←→ [MITM Proxy/Server] ←→ [relay_client.py] ←→ [Target Device]
                         ↓
                  [Interception/Modification]
```

The relay client can be extended to:
- Act as a BLE peripheral (advertise itself)
- Relay communications between a central device and the real peripheral
- Inject, modify, or drop packets in transit
- Log all communications for analysis

## Why This Commit Matters

1. **Completes the Research Workflow**: Bridges discovery/enumeration with active testing
2. **Enables Hands-On Analysis**: Researchers can interact with devices in real-time
3. **Foundation for MITM**: Provides the peripheral connection component needed for full MITM
4. **Academic Tool**: Designed for security research and education (as noted in README)
5. **Real Device Testing**: Includes actual OAT1040 device profile for practical research

## Target Device: OAT1040

The OAT1040 mentioned in the commit message appears to be a **BLE-enabled sensor/actuator device**. Based on the profile:
- Has battery monitoring (Battery Service)
- Supports notifications for sensor data streaming
- Has writable characteristics for control/configuration
- Uses standard BLE GATT profiles plus custom services

## Conclusion

Commit b492274 represents the **third and most critical phase** of the BLE MITM research tool. It transforms the project from a passive analysis tool (scanner + enumerator) into an **active security research platform** capable of:

- Maintaining persistent connections to BLE devices
- Intercepting real-time data streams
- Injecting commands and testing device responses
- Serving as the foundation for complete MITM attack demonstrations

This commit is essential for academic security research, penetration testing education, and vulnerability analysis of BLE devices, particularly focusing on devices like the OAT1040 that use BLE for control and monitoring applications.
